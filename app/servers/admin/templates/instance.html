{% extends "base.html" %}
{% block content %}
    <div class="container">
        <br/>

        <div class="row">
            <div class="col-md-5">
                {{ wtf.quick_form(form, form_type='inline', button_map={'submit_button': 'primary'}) }}
            </div>
            <div class="col-md-1">
                <a class="btn btn-success" type="button" href='{{ url_for("admin.instances", all="true") }}'>All
                    Instances</a>
            </div>
        </div>
        {% if instances %}
            <font color="red"><h3>total: {{ instance_num }}</h3></font>

            <table class="table table-striped table-bordered">
                <thead>
                <tr>
                    <th class="mid-td" style="width: 30%">Instance ID</th>
                    <th class="mid-td" style="width: 10%">Group ID</th>
                    <th class="mid-td" style="width: 10%">App ID</th>
                    <th class="mid-td" style="width: 10%">App Version</th>
                    <th class="mid-td" style="width: 10%">Instance IP</th>
                    <th class="mid-td" style="width: 10%">Instance Port</th>
                    <th class="mid-td" style="width: 10%">Agent IP</th>
                    <th class="mid-td" style="width: 15%">Status</th>
                    {% if g.user.is_authenticated() %}
                        <th class="mid-td" style="width: 15%">Ops</th>
                    {% endif %}
                </tr>
                </thead>

                <tbody>
                {% for instance in instances %}
                    <tr>
                        <td class="mid-td">
                            {{ instance.instance_id }}
                        </td>

                        <td class="mid-td">
                            {{ instance.instance_group_id }}
                        </td>

                        <td class="mid-td">
                            {{ instance.app_id }}
                        </td>

                        <td class="mid-td">
                            {{ instance.app_version }}
                        </td>

                        <td class="mid-td">
                            {{ instance.instance_ip }}
                        </td>

                        <td class="mid-td">
                            {{ instance.instance_port }}
                        </td>

                        <td class="mid-td">
                            {% if instance.agent_ip %}
                                <a href="{{ url_for('admin.show_agent', machine_id = instance.machine_id) }}">{{ instance.agent_ip }}</a>
                            {% else %}
                                {{ instance.agent_ip }}
                            {% endif %}
                        </td>

                        <td class="mid-td">
                            <font color="{{ '' if instance.status == 200 else 'red' }}">{{ instance.status_desc }}</font>
                        </td>
                        {% if g.user.is_authenticated() %}

                            {% if instance.status in [200,501,502,503,504] %}
                                <td class="mid-td">
                                    <a class="btn btn-success btn-custom btn-sm" type="button"
                                       href='{{ url_for('api.shutdown_instance', app_id=instance.app_id, instance_id= instance.instance_id,type=form.type.data, value=form.value.data) }}'
                                       onclick='{if(confirm("Are you sure to shutdown this instance?")){return true;}return false;}'>Shutdown</a>
                                </td>
                            {% endif %}

                            {% if instance.status in [500,505] %}
                                <td class="mid-td">
                                    <a class="btn btn-success btn-custom btn-sm" type="button"
                                       href='{{ url_for('api.restart_instance', app_id=instance.app_id, instance_id=instance.instance_id, type=form.type.data, value=form.value.data) }}'
                                       onclick='{if(confirm("Are you sure to start this instance?")){return true;}return false;}'>Start</a>
                                </td>
                            {% endif %}
                        {% endif %}

                    </tr>
                {% endfor %}
                </tbody>
            </table>
        {% endif %}
    </div>


{% endblock %}

{% block scripts %}
    {{ super() }}

    <script type="text/javascript">
        function setDataSource() {
            $("#value").attr("data-provide", "typeahead");
            $("#value").attr("data-source", '{{ app_ids|safe}}');
            $("#value").attr("data-items", "10");
            $("#value").attr("placeholder", "Enter App ID and Version")
        }

        function clearDataSource() {
            $("#value").attr("data-provide", "");
            $("#value").attr("data-source", '');
            $("#value").attr("placeholder", "Enter Machine IP")
        }

        $(document).ready(function () {
            $("#value").attr("autocomplete", "off");
            setDataSource();
        });

        $('#type').change(function () {
            var type = $(this).children('option:selected').val();

            if (type == 0) {
                clearDataSource();
            } else {
                setDataSource();
            }
        });

    </script>
{% endblock %}
